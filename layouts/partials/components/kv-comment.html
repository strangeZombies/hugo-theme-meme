<style>
    .kv-info  {
        border-top: 2px double #777;
        font-size: 1.2em;
        line-height: 1.6em;
        font-weight: 700;
        margin: -.4em 0 .4em 0;
    }
    .kv-cmt {
        font-size: .9em;
        font-weight: 700;
    }
</style>
<div class="kv-info">ğŸ’¬ è¯„ è®º</div>
<div class="kv-cmt" endpoint="https://comments.takami.cyou"></div>
<script>
var kv_comment_parent = null

// è·å–è¯„è®ºå®¹å™¨å’ŒAPIç«¯ç‚¹
const container = document.querySelector('.kv-cmt');
const endpoint = container.getAttribute('endpoint')

//æ·»åŠ è¯„è®ºåˆ—è¡¨å®¹å™¨
const commentsContainer = document.createElement('div');
commentsContainer.classList.add('kv-comments');
commentsContainer.id = 'kv';
container.appendChild(commentsContainer);

//æ·»åŠ æ–°è¯„è®ºå®¹å™¨
const newCommentContainer = document.createElement('div');
newCommentContainer.classList.add('kv-newcomment');
newCommentContainer.innerHTML = `
<textarea name="kv-comment-value" id="kv-comment-value" placeholder="åœ¨è¿™é‡Œè¯„è®º" cols="30" rows="10"></textarea>
<div class="kv-toolbar">
<span>æ–°è¯„è®º / </span><span style="display: none;">æ–°å›å¤ / </span><span>ç”± </span><input type="text" name="kv-comment-user" id="kv-comment-user" value="åŒ¿å">
<button id="kv-comment-submit" >å‘è¡¨</button>
</div>
`;
container.appendChild(newCommentContainer);

const replyLabel = '<span class="kv-reply">reply</span>';


//åˆ›å»ºè¡¨ç¤ºå•ä¸ªè¯„è®ºçš„HTMLå…ƒç´ 
function createCommentElement(comment) {
    const commentElem = document.createElement('div');
    commentElem.id = `kv-${comment.key}`;
    commentElem.classList.add('kv-comment');
    commentElem.innerHTML = `
<div class="kv-body">
<div class="kv-stat">BY ${comment.user} / AT ${new Date(comment.time).toLocaleString()} ${replyLabel}</div>
<div class="kv-content">${comment.content}</div>
<hr class="kv-hr">
</div>
`;
    return commentElem;
}

//è·å–è¯„è®ºåˆ—è¡¨
fetch(`${endpoint}/?url=${window.location.href}`)
    .then(response => response.json())
    .then(comments => {
        //éå†JSONæ•°ç»„å¹¶ä¸ºæ¯ä¸ªè¯„è®ºåˆ›å»ºHTMLå…ƒç´ 
        comments.forEach(comment => {
            const commentElem = createCommentElement(comment);
            if (!comment.key.includes('|')) {
                commentsContainer.appendChild(commentElem);
            } else {
                const id = comment.key;
                const parentId = id.substring(0, id.lastIndexOf('|')); // è·å–çˆ¶çº§è¯„è®ºçš„ ID
                const parentComment = document.getElementById(`kv-${parentId}`); // æŸ¥æ‰¾å…ƒç´ 
                parentComment.appendChild(commentElem)
            }
        });
    });


//ä¸ºâ€œå›å¤â€æ ‡ç­¾æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
commentsContainer.addEventListener('click', event => {
    if (event.target.classList.contains('kv-reply')) {
        const commentElem = event.target.closest('.kv-comment');
        kv_comment_parent = commentElem.id.split('-')[1]
        const toolbar = newCommentContainer.querySelector('.kv-toolbar');
        toolbar.children[0].style.display = 'none';
        toolbar.children[1].style.display = '';
    }
});

//ä¸ºæäº¤å¢åŠ ç›‘å¬å™¨
const submitBtn = document.getElementById('kv-comment-submit');
submitBtn.addEventListener('click', async () => {
    const commentValue = document.getElementById('kv-comment-value').value;
    const commentUser = document.getElementById('kv-comment-user').value;

    // æ„é€ è¯·æ±‚ä½“
    const requestBody = {
        url: window.location.href,
        content: commentValue,
        user: commentUser,
        parent: kv_comment_parent, // å‡è®¾å·²çŸ¥çˆ¶çº§è¯„è®ºçš„ ID
    };

    try {
        const response = await fetch(`${endpoint}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody),
        });

        if (response.ok) {
            const responseBody = await response.json();
            alert(responseBody.message);
        } else {
            console.error(`Failed to post comment. Status code: ${response.status}`);
        }
    } catch (error) {
        console.error(`Failed to post comment. Error: ${error}`);
    }
});
</script>